name: Publish

on:
  workflow_dispatch:
    inputs:
      publish_east_ui:
        description: 'Publish @elaraai/east-ui'
        required: true
        default: true
        type: boolean
      publish_east_ui_components:
        description: 'Publish @elaraai/east-ui-components'
        required: true
        default: true
        type: boolean
      publish_vscode:
        description: 'Publish VSCode extension'
        required: true
        default: true
        type: boolean
      npm_tag:
        description: 'npm tag (latest or beta)'
        required: true
        default: 'latest'
        type: choice
        options:
          - latest
          - beta

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for npm trusted publishers (OIDC)
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Upgrade npm for trusted publishing
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Run linter
        run: npm run lint

      # Publish npm packages in dependency order (using OIDC trusted publishers)
      # 1. east-ui (core types and platform functions)
      - name: Publish @elaraai/east-ui
        if: ${{ inputs.publish_east_ui }}
        run: npm publish --access public --provenance --tag ${{ inputs.npm_tag }}
        working-directory: packages/east-ui

      # 2. east-ui-components (depends on east-ui)
      - name: Update east-ui-components workspace dependency
        if: ${{ inputs.publish_east_ui_components }}
        run: |
          EAST_UI_VERSION=$(node -p "require('./packages/east-ui/package.json').version")
          cd packages/east-ui-components
          npm pkg set "dependencies.@elaraai/east-ui=^${EAST_UI_VERSION}"

      - name: Publish @elaraai/east-ui-components
        if: ${{ inputs.publish_east_ui_components }}
        run: npm publish --access public --provenance --tag ${{ inputs.npm_tag }}
        working-directory: packages/east-ui-components

      # 4. VSCode Extension
      - name: Build VSCode extension
        if: ${{ inputs.publish_vscode }}
        run: npm run build && npm run package
        working-directory: packages/east-ui-extension

      - name: Publish VSCode extension
        if: ${{ inputs.publish_vscode }}
        run: npx vsce publish --no-dependencies ${{ inputs.npm_tag == 'beta' && '--pre-release' || '' }}
        working-directory: packages/east-ui-extension
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
